---
title: "Company and jobroles infoFinder"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

# Initiation

## R libraries

```{r}
library(googlesheets4)
library(conflicted)
library(tidyverse)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::select)

knitr::opts_chunk$set(echo = TRUE)
library(reticulate)
```

## Python packages

```{python}
import openai
import os
import pandas as pd
import ast

app_key = os.environ.get("OPENAI_API_KEY")

df = pd.DataFrame()
```

# Data

```{r}
ss <- "https://docs.google.com/spreadsheets/d/1xzpre5Ej_7OEGRU4EA7KZuMQnSz5YCyTx5Sdbml6bQE/edit#gid=0"

main <- read_sheet(ss, sheet = "Main")

companyAnalysis <- read_sheet(ss, sheet = "CompanyAnalysis")

locations_coord <- read_sheet(ss, sheet = "locations_coord")

to_be_uploaded <- data.frame( Name = character(), Description = numeric(0), Number_of_ads = numeric(0),
                              Location_of_jobs = numeric(0), Multinational = numeric(0),
                              Organisation_type = numeric(0), Ownership_type = numeric(0),
                              Industry_Sector = numeric(0), Hydrogen_relevance = numeric(0),
                              Hydrogen_relevance_motivation = numeric(0), 
                              Hydrogen_specialist = numeric(0), Nationality = numeric(0),
                              Founded_year = numeric(0))
```

# Companies

Finding unique and new companies

```{r}
all_companies <- main %>%
  select(Company) %>%
  unique() %>%
  arrange(Company)

previously_known_companies <- companyAnalysis %>%
  select(Name)

new_companies <- anti_join(all_companies,previously_known_companies,by = c("Company" = "Name"))
```

Calculate number of ads published by each company

```{r}
nr_of_ads <- main %>%
  count(Company, name = 'Number_of_ads')

colnames(nr_of_ads) <- c("Name","Number_of_ads")

to_be_uploaded <- to_be_uploaded %>%
  bind_rows(nr_of_ads %>% select(any_of(names(to_be_uploaded))))
```

Compile in what countries each company is recruiting

```{r}
company_country <- main %>%
  select(Company,Location) %>%
  separate_rows(Location, sep = ", ") %>%
  # Optionally, trim any extra whitespace (just in case)
  mutate(Location = trimws(Location)) %>%
  left_join(locations_coord %>% select(New_name,country_code) %>% unique(),
            by = c('Location' = 'New_name')) %>%
  select(Company,country_code) %>%
  unique() %>%
  group_by(Company) %>%
  summarise(country_code = paste(sort(unique(country_code)), collapse = ", ")) %>%
  ungroup() 

colnames(company_country) <- c("Name","Location_of_jobs")

to_be_uploaded <- to_be_uploaded %>%
  left_join(company_country, by = "Name") %>%  
  mutate(Location_of_jobs = Location_of_jobs.y) %>%         
  select(Name, Description, Number_of_ads, Location_of_jobs, Multinational, Organisation_type,
         Ownership_type, Industry_Sector, Hydrogen_relevance, Hydrogen_relevance_motivation, 
         Hydrogen_specialist, Nationality, Founded_year, -Location_of_jobs.y, -Location_of_jobs.x)      

```
